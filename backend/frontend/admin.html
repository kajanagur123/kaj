<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Z2A Academy - Admin Portal</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Admin Portal</h1>

  <!-- Login Form -->
  <form id="loginForm">
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" class="primary">Login</button>
  </form>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" style="display:none;">
    <h2>Manage Students</h2>



    <!-- Student Form -->
    <form id="studentForm">
      <input type="hidden" id="studentId"> <!-- For editing -->

      <input type="text" id="name" placeholder="Name" required>
      <input type="text" id="roll" placeholder="Roll" required>
      <input type="date" id="dob" placeholder="DOB" required>
      <input type="text" id="grade" placeholder="Grade" required>

      <input type="text" id="subjects" placeholder="Subjects (comma-separated)" required>
      <input type="text" id="marks" placeholder="Marks (comma-separated)" required>
      <input type="text" id="subjectResults" placeholder="Pass/Fail for each subject (comma-separated)" required>

      <input type="number" id="total" placeholder="Total" readonly>
      <input type="text" id="passFail" placeholder="Overall Pass/Fail" required>

      <button type="submit" class="success">Save Student</button>
          <!-- Action Buttons -->
    <button type="button" id="newStudentBtn" class="primary">Add Student</button>
    </form>

    <!-- Student Table -->
    <table id="studentTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll</th>
          <th>Grade</th>
          <th>Subjects</th>
          <th>Marks</th>
          <th>Subject Results</th>
          <th>Total</th>
          <th>Overall</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const apiUrl = "http://localhost:5000/api";
    let token = "";

    // LOGIN
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const res = await fetch(apiUrl + "/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });
      const data = await res.json();

      if (res.ok) {
        token = data.token;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("adminDashboard").style.display = "block";
        loadStudents();
      } else {
        alert(data.message || "Login failed");
      }
    });

    // RESET FORM (New Student)
    document.getElementById("newStudentBtn").addEventListener("click", () => {
      document.getElementById("studentForm").reset();
      document.getElementById("studentId").value = "";
      document.getElementById("total").value = "";
    });

    // AUTO CALCULATE TOTAL
    document.getElementById("marks").addEventListener("input", () => {
      const marks = document.getElementById("marks").value
        .split(",")
        .map(m => parseInt(m.trim()))
        .filter(m => !isNaN(m));
      const sum = marks.reduce((a, b) => a + b, 0);
      document.getElementById("total").value = sum;
    });

    // LOAD STUDENTS
    async function loadStudents() {
      const res = await fetch(apiUrl + "/students", {
        headers: { Authorization: "Bearer " + token },
      });
      const students = await res.json();

      const tbody = document.querySelector("#studentTable tbody");
      tbody.innerHTML = "";

      students.forEach((s) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.roll}</td>
          <td>${s.grade}</td>
          <td>${s.subjects.join(", ")}</td>
          <td>${s.marks.join(", ")}</td>
          <td>${s.subjectResults ? s.subjectResults.join(", ") : "-"}</td>
          <td>${s.total}</td>
          <td>${s.passFail}</td>
          <td>
            <button onclick="editStudent('${s._id}')">Edit</button>
            <button onclick="deleteStudent('${s._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // SAVE STUDENT (Add or Update)
    document.getElementById("studentForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const studentId = document.getElementById("studentId").value;
      const student = {
        name: document.getElementById("name").value,
        roll: document.getElementById("roll").value,
        dob: document.getElementById("dob").value,
        grade: document.getElementById("grade").value,
        subjects: document.getElementById("subjects").value.split(",").map(s => s.trim()),
        marks: document.getElementById("marks").value.split(",").map(m => parseInt(m.trim())),
        subjectResults: document.getElementById("subjectResults").value.split(",").map(r => r.trim()),
        total: parseInt(document.getElementById("total").value),
        passFail: document.getElementById("passFail").value,
      };

      let res;
      if (studentId) {
        res = await fetch(apiUrl + "/students/" + studentId, {
          method: "PUT",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
          body: JSON.stringify(student),
        });
      } else {
        res = await fetch(apiUrl + "/students", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
          body: JSON.stringify(student),
        });
      }

      if (res.ok) {
        alert("Student saved successfully!");
        document.getElementById("studentForm").reset();
        document.getElementById("studentId").value = "";
        document.getElementById("total").value = "";
        loadStudents();
      } else {
        const data = await res.json();
        alert(data.message || "Error saving student");
      }
    });

    // EDIT STUDENT
    async function editStudent(id) {
      const res = await fetch(apiUrl + "/students/" + id, {
        headers: { Authorization: "Bearer " + token },
      });
      const s = await res.json();

      document.getElementById("studentId").value = s._id;
      document.getElementById("name").value = s.name;
      document.getElementById("roll").value = s.roll;
      document.getElementById("dob").value = s.dob.split("T")[0];
      document.getElementById("grade").value = s.grade;
      document.getElementById("subjects").value = s.subjects.join(", ");
      document.getElementById("marks").value = s.marks.join(", ");
      document.getElementById("subjectResults").value = s.subjectResults ? s.subjectResults.join(", ") : "";
      document.getElementById("total").value = s.total;
      document.getElementById("passFail").value = s.passFail;
    }

    // DELETE STUDENT
    async function deleteStudent(id) {
      if (!confirm("Are you sure you want to delete this student?")) return;

      const res = await fetch(apiUrl + "/students/" + id, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token },
      });

      if (res.ok) {
        alert("Student deleted");
        loadStudents();
      } else {
        alert("Error deleting student");
      }
    }
  </script>
</body>
</html>
